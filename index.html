<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <link rel="stylesheet" href="./style.css">
    <title>VanillaJSWeatherApp</title>
</head>

<body>
    <div class="container">
        <h1>Today's Weather</h1>
        <form class="zipcode">
            <label for="zip">Zip Code:</label>&nbsp;
            <input type="text" name="zip" id="zip">
            <input type="submit" value="submit">
        </form>
        <div class="weatherDisplay">
            <section class="dataDisplay"></section>
        </div>
        <form class="todoInput">
            <label for="todo">Todo:</label>&nbsp;
            <input type="text" name="todo" id="todo">
            <input type="submit" value="submit">
        </form>
        <div class="todoDisplay">
            <ul class="todoList">


            </ul>
        </div>
    </div>

</body>

<script>
    const searchInput = document.querySelector('.zipcode');
    const weatherDisplay = document.querySelector('.weatherDisplay');
    const dataDisplay = document.querySelector('.dataDisplay');
    const todoDisplay = document.querySelector('.todoDisplay');
    const todoList = document.querySelector('.todoList');
    const todoInput = document.querySelector('.todoInput');
    const tasks = JSON.parse(localStorage.getItem('tasks')) || [];

    console.log("thanks for checking this app out!")

    const weatherPics = {
        dawn: "./assets/saad-chaudhry-cYpqYxGeqts-unsplash.jpg",
        day: "./assets/mick-haupt-OVX3oiL5PsE-unsplash.jpg",
        dusk: "./assets/benjamin-davies-9b5dvrjb05g-unsplash.jpg",
        night: "./assets/nathan-jennings-VsPsf4F5Pi0-unsplash.jpg"
    }

    function lookUpZip(e) {
        e.preventDefault()
        let searchZip = this.querySelector('[name=zip]').value;
        if (!searchZip) {
            alert('Please Enter ZipCode')
        } else if (searchZip) {
            fetchWeather(searchZip)
        }
        this.reset()
    }

    async function fetchWeather(zipCode) {
        const weatherAPI =
            `https://api.openweathermap.org/data/2.5/weather?zip=${zipCode},US&appid=c03667c8e0d1189bf74000c04cbad51f`;

        await fetch(weatherAPI)
            .then(response => {
                return response.json();
            }).then(data => {
                return fetch(
                    `http://api.openweathermap.org/geo/1.0/reverse?lat=${data.coord.lat}&lon=${data.coord.lon}&limit=5&appid=c03667c8e0d1189bf74000c04cbad51f`
                ).then(response => {
                    return response.json();
                }).then(content => {
                    displayData(data, content)
                })
            })
    }

    function displayData(data, content) {
        let background = '';
        let date = new Date(data.dt * 1000);
        let hour = date.getHours();

        if (hour >= 6 && hour <= 9) {
            background = `url(${weatherPics.dawn})`
        } else if (hour >= 10 && hour <= 17) {
            background = `url(${weatherPics.day})`
        } else if (hour >= 18 && hour <= 20) {
            background = `url(${weatherPics.dusk})`
        } else {
            background = `url(${weatherPics.night})`
        }
        weatherDisplay.style.backgroundImage = background;

        return dataDisplay.innerHTML = `
        <h5>${content[0].state}</h5>
        <h5>${date.toLocaleDateString()}</h5>
        <h5>${date.toLocaleTimeString()}</h5>
        <h1>${content[0].name}</h1>
        <h3>${data.weather[0].description}</h3>
        <h2>${Math.floor(data.main.temp * 1.8 - 459.67)}째</h2>
        <p>Feels Like: ${Math.floor(data.main.feels_like * 1.8 - 459.67)}째</p>
        <p>Humidity: ${data.main.humidity}%</p>
        <p>Today's High: ${Math.floor(data.main.temp_max * 1.8 - 459.67)}째</p>
        <p>Today's Low: ${Math.floor(data.main.temp_min * 1.8 - 459.67)}째</p>
       `
    }

    function addTask(e) {
        e.preventDefault();
        const text = this.querySelector('[name=todo]').value
        const task = {
            text,
            done: false,
        }
        tasks.push(task)
        localStorage.setItem('tasks', JSON.stringify(tasks));
        populateTasks(tasks, todoList)
        this.reset();
    }

    function populateTasks(tasks = [], todoList) {
        todoList.innerHTML = tasks.map((task, i) => {
            return `
                <li>
                    <p>${task.text}</p>
                    <button type="click" name="complete" data-index=${i}>X</button>
                </li>
            `
        }).join('');
    }

    function removeTask(e) {
        if (!e.target.matches('button')) return;
        const elementIndex = e.target.dataset.index;
        tasks.splice(elementIndex, 1);
        localStorage.setItem('tasks', JSON.stringify(tasks))
        populateTasks(tasks, todoList);
    }



    searchInput.addEventListener('submit', lookUpZip);
    todoInput.addEventListener('submit', addTask);
    todoList.addEventListener('click', removeTask)
    populateTasks(tasks, todoList)
</script>

</html>
